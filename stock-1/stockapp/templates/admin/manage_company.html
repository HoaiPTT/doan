{% extends 'admin/base_layout.html' %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<section class="section">
  <div class="section-header">
    <h1>Manage Company</h1>
  </div>

  <div class="section-body">
    <div class="row">
      <div class="card" style="flex-grow: 1;">
        <div class="card-header" style="justify-content: space-between;">
          <button class="btn btn-success add-button" onclick="openAddModal()">+ Add Company</button>
          <form style="flex-grow: 0.1;">

            <form style="flex-grow: 0.1;">
              <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search">
                <div class="input-group-btn">
                  <button class="btn btn-primary" id="searchButton"><i class="fas fa-search"></i></button>
                </div>
              </div>
            </form>
        </div>
        <div class="card-body">
          <div class="section-title mt-0">Light</div>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th scope="col">Symbol</th>
                <th scope="col">Company name</th>
                <th scope="col">Industry</th>
                <th scope="col">Exchange</th>
                <th scope="col">Profile</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
          <div id="pagination" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal" id="editCompanyModal"
  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">

  <div class="modal-content" style="
        background:#fff; 
        padding:30px; 
        border-radius:10px; 
        width:700px;        
        max-height:80%;     
        overflow-y:auto;    
        position:relative;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    ">
    <h3 style="margin-bottom:20px;">Edit Company</h3>
    <input type="hidden" id="editSymbol">
    <div class="form-group" style="margin-bottom:15px;">
      <label>Company Name</label>
      <input type="text" id="editCompanyName" class="form-control" style="width:100%; padding:8px; font-size:14px;">
    </div>
    <div class="form-group" style="margin-bottom:15px;">
      <label>Industry</label>
      <input type="text" id="editIndustry" class="form-control" style="width:100%; padding:8px; font-size:14px;">
    </div>
    <div class="form-group" style="margin-bottom:15px;">
      <label>Exchange</label>
      <input type="text" id="editExchange" class="form-control" style="width:100%; padding:8px; font-size:14px;">
    </div>
    <div class="form-group" style="margin-bottom:20px;">
      <label>Profile</label>
      <textarea id="editProfile" class="form-control"
        style="width:100%; padding:8px; font-size:14px; min-height:150px;"></textarea>
    </div>
    <div style="text-align:right;">
      <button class="btn btn-success" onclick="saveCompany()" style="margin-right:10px;">Save</button>
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- üü¢ Modal Add Company -->
<div class="modal" id="addCompanyModal"
  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
  <div class="modal-content"
    style="background:#fff; padding:30px; border-radius:10px; width:700px; max-height:80%; overflow-y:auto; position:relative;">
    <h3>Add New Company</h3>
    <div class="form-group"><label>Symbol</label><input type="text" id="addSymbol" class="form-control"></div>
    <div class="form-group"><label>Company Name</label><input type="text" id="addCompanyName" class="form-control">
    </div>
    <div class="form-group"><label>Industry</label><input type="text" id="addIndustry" class="form-control"></div>
    <div class="form-group"><label>Exchange</label><input type="text" id="addExchange" class="form-control"></div>
    <div class="form-group"><label>Profile</label><textarea id="addProfile" class="form-control"></textarea></div>
    <div style="text-align:right;">
      <button class="btn btn-primary" onclick="createCompany()">Create</button>
      <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
    </div>
  </div>
</div>


<script>
  function closeEditModal() {
    document.getElementById('editCompanyModal').style.display = 'none';
  }
</script>


<style>
  .add-button:hover {
    background-color: #e7ffe761;
    color: #39a739 !important;
    border-radius: 6px;
    box-shadow: 0px 5px 10px 5px #e8fbe8b0;
    cursor: pointer;
    text-decoration: underline !important;
  }
</style>
<script>
  const admin_token = localStorage.getItem('admin_token');
  const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  let currentPage = 1;
  const limit = 5;

  async function fetchCompany(page = 1) {
    currentPage = page;
    const searchQuery = document.getElementById("searchInput").value.trim();

    const response = await fetch(`/get_list_companys?search=${encodeURIComponent(searchQuery)}&page=${page}&limit=${limit}`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bear ${admin_token}`
        }
      });
    const data = await response.json();

    if (data.success) {
      renderCompany(data.list_company);
      renderPagination(data.total_pages, currentPage);
    } else {
      document.getElementById("userList").innerHTML = `<p class="text-danger">No users found!</p>`;
      document.getElementById("pagination").innerHTML = "";
    }
  }
  function renderPagination(totalPages, currentPage) {
    let paginationHTML = `<nav><ul class="pagination">`;

    paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" onclick="fetchCompany(${currentPage - 1})">Previous</a></li>`;

    let range = [1, totalPages];
    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++)
      range.push(i);

    range = [...new Set(range)].sort((a, b) => a - b);

    range.forEach((i, idx) => {
      if (idx > 0 && i !== range[idx - 1] + 1) paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" onclick="fetchCompany(${i})">${i}</a></li>`;
    });

    paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" onclick="fetchCompany(${currentPage + 1})">Next</a></li>`;

    document.getElementById("pagination").innerHTML = paginationHTML + `</ul></nav>`;
  }


  fetchCompany();
  document.getElementById("searchButton").addEventListener("click", function (event) {
    event.preventDefault();
    currentPage = 1;
    fetchCompany();
  });
  async function renderCompany(list_user) {
    const tbody = document.querySelector('.table tbody');
    tbody.innerHTML = '';
    data = list_user;
    data.forEach(Element => {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td>${Element.symbol}</td>
                    <td>${Element.company_name}</td>
                    <td>${Element.industry}</td>
                    <td>${Element.exchange}</td>
                    <td>${Element.profile}</td>
                   <td>
  <div style="display:flex; justify-content:center; gap:12px; align-items:center;">
    <i class="fas fa-edit text-warning"
       style="cursor:pointer; font-size:18px;"
       title="Edit"
       onclick="editCompany('${Element.symbol}')"></i>
    <i class="fas fa-trash text-danger"
       style="cursor:pointer; font-size:18px;"
       title="Delete"
       onclick="confirmDelete('${Element.symbol}')"></i>
  </div>
</td>


                `;
      tbody.append(row);
    });

  }
  async function saveCompany() {
    const symbol = document.getElementById('editSymbol').value;
    const company_name = document.getElementById('editCompanyName').value.trim();
    const industry = document.getElementById('editIndustry').value.trim();
    const exchange = document.getElementById('editExchange').value.trim();
    const profile = document.getElementById('editProfile').value.trim();

    try {
      const response = await fetch('/ad/api/edit_company/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'Authorization': `Bear ${admin_token}`
        },
        body: JSON.stringify({ symbol, company_name, industry, exchange, profile })
      });

      const data = await response.json();
      if (data.success) {
        Swal.fire('Success', data.message, 'success');
        closeEditModal();
        fetchCompany(currentPage); // load l·∫°i b·∫£ng
      } else {
        Swal.fire('Error', data.message || 'Update failed', 'error');
      }
    } catch (err) {
      Swal.fire('Error', err.message || 'Update failed', 'error');
    }
  }
  // üü¢ Th√™m c√¥ng ty
  function openAddModal() {
    document.getElementById('addCompanyModal').style.display = 'flex';
  }
  function closeAddModal() {
    document.getElementById('addCompanyModal').style.display = 'none';
  }
  async function createCompany() {
    const payload = {
      symbol: document.getElementById('addSymbol').value.trim(),
      company_name: document.getElementById('addCompanyName').value.trim(),
      industry: document.getElementById('addIndustry').value.trim(),
      exchange: document.getElementById('addExchange').value.trim(),
      profile: document.getElementById('addProfile').value.trim()
    };
    const response = await fetch('/ad/api/add_company/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'Authorization': `Bear ${admin_token}`
      },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (data.success) {
      Swal.fire('Success', 'Company added successfully!', 'success');
      closeAddModal();
      fetchCompany(1);
    } else {
      Swal.fire('Error', data.message || 'Failed to add company', 'error');
    }
  }

// üóëÔ∏è Xo√° c√¥ng ty

// üóëÔ∏è Xo√° c√¥ng ty
async function confirmDelete(symbol) {
  const result = await Swal.fire({
    title: 'Are you sure?',
    text: `You want to delete company "${symbol}"?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  });

  if (result.isConfirmed) {
    const response = await fetch(`/ad/api/delete_company/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'Authorization': `Bear ${admin_token}`
      },
      body: JSON.stringify({ symbol })
    });

    const data = await response.json();
    if (data.success) {
      Swal.fire('Deleted!', data.message, 'success');
      fetchCompany(currentPage);
    } else {
      Swal.fire('Error', data.message || 'Failed to delete', 'error');
    }
  }
}



</script>
<style>
  .input-group {
    position: relative;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    -ms-flex-align: stretch;
    align-items: stretch;
    width: 100%;
  }
</style>

<script>
  function editCompany(symbol) {
    // T√¨m row t∆∞∆°ng ·ª©ng v·ªõi symbol
    const row = [...document.querySelectorAll('.table tbody tr')]
      .find(tr => tr.children[0].textContent === symbol);

    // L·∫•y d·ªØ li·ªáu t·ª´ row v√† ƒë·∫©y v√†o form
    document.getElementById('editSymbol').value = symbol;
    document.getElementById('editCompanyName').value = row.children[1].textContent;
    document.getElementById('editIndustry').value = row.children[2].textContent;
    document.getElementById('editExchange').value = row.children[3].textContent;
    document.getElementById('editProfile').value = row.children[4].textContent;

    // Hi·ªÉn th·ªã form
    document.getElementById('editCompanyModal').style.display = 'flex';
  }

</script>
{% endblock %}